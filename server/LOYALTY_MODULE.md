# üé´ –ú–æ–¥—É–ª—å Loyalty Card –¥–ª—è Telegram Bot

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å "Loyalty Card" (—à—Ç–∞–º–ø-–∫–∞—Ä—Ç–∞) –¥–ª—è Telegram –±–æ—Ç–∞ CRUSTA MIA. –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å —à—Ç–∞–º–ø—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏ –ø–∏—Ü—Ü—ã –∏ –∫–æ—Ñ–µ, –ø–æ–ª—É—á–∞—è –∫–∞–∂–¥—É—é 6-—é –ø–æ–∑–∏—Ü–∏—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ.

## üèó –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
server/loyalty/
‚îú‚îÄ‚îÄ schema.sql      # –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite
‚îú‚îÄ‚îÄ db.ts          # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îú‚îÄ‚îÄ service.ts     # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ ui.ts          # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
‚îú‚îÄ‚îÄ commands.ts    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
‚îî‚îÄ‚îÄ admin.ts       # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
```

## üóÑ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã:
- **users** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram
- **loyalty** - –¥–∞–Ω–Ω—ã–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (—à—Ç–∞–º–ø—ã, —Ü–∏–∫–ª—ã)
- **transactions** - –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –°—Ö–µ–º–∞:
- **–ü–∏—Ü—Ü–∞**: 0-5 —à—Ç–∞–º–ø–æ–≤, –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 5 - —Å–±—Ä–æ—Å –Ω–∞ 0 + +1 –∫ —Ü–∏–∫–ª–∞–º
- **–ö–æ—Ñ–µ**: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–∏—Ü—Ü–µ
- **–¶–∏–∫–ª—ã**: —Å—á–µ—Ç—á–∏–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –ø–∞–ø–∫–µ `server/`:

```env
# Telegram Bot Configuration
BOT_TOKEN=your_bot_token_here

# Admin Configuration (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
ADMIN_IDS=123456789,987654321

# Database Configuration
LOYA_DB_PATH=server/data/loyalty.sqlite

# Environment
NODE_ENV=development
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd server
npm install
```

### 3. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev

# –ü—Ä–æ–¥–∞–∫—à–µ–Ω
npm run build
npm start
```

## üì± –ö–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- `/start` - –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- `/card` –∏–ª–∏ `/mycard` - –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

### –ü—Ä–∏–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏:
```
üë§ Test User

üçï –ü–∏—Ü—Ü–∞: 3/5   ‚óè‚óè‚óè‚óã‚óã
‚òïÔ∏è –ö–æ—Ñ–µ:  4/5   ‚óè‚óè‚óè‚óè‚óã

_–ó–∞ –∫–∞–∂–¥—ã–µ 5 ‚Äî 6-—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ._

üéÅ –ü–æ–¥–∞—Ä–µ–Ω–æ: –ø–∏—Ü—Ü–∞ √ó2, –∫–æ—Ñ–µ √ó1
```

## üë®‚Äçüíº –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- `/admin` - –æ—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- `/add_pizza <tg_id>` - –Ω–∞—á–∏—Å–ª–∏—Ç—å —à—Ç–∞–º–ø –ø–∏—Ü—Ü—ã
- `/add_coffee <tg_id>` - –Ω–∞—á–∏—Å–ª–∏—Ç—å —à—Ç–∞–º–ø –∫–æ—Ñ–µ

### –ü—Ä–∏–º–µ—Ä—ã:
```bash
/add_pizza 123456789
/add_coffee 123456789
```

### –ò–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏:
- **üçï +1** - –Ω–∞—á–∏—Å–ª–∏—Ç—å —à—Ç–∞–º–ø –ø–∏—Ü—Ü—ã
- **‚òïÔ∏è +1** - –Ω–∞—á–∏—Å–ª–∏—Ç—å —à—Ç–∞–º–ø –∫–æ—Ñ–µ

## üîß API —Ñ—É–Ω–∫—Ü–∏–π

### service.ts

```typescript
// –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
upsertUser(from: TelegramUser): Promise<User>

// –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ Telegram ID
getCardByTgId(tgId: number): Promise<{user, card} | null>

// –î–æ–±–∞–≤–∏—Ç—å —à—Ç–∞–º–ø
addStamp(tgId: number, kind: 'pizza'|'coffee', admin_tg_id: number): Promise<{user, card}>

// –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —à—Ç–∞–º–ø–æ–≤
adjustStamp(tgId: number, kind: 'pizza'|'coffee', delta: number, admin_tg_id: number): Promise<{user, card}>
```

### ui.ts

```typescript
// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–æ—á–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
renderDots(n: number): string

// –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
cardMessage(fullname: string, pizza: number, coffee: number, pCycles: number, cCycles: number): string
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
npx tsx test-loyalty.ts
```

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à—Ç–∞–º–ø–∞
4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–ê–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø**: —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ `ADMIN_IDS`
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `transactions`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```sql
SELECT * FROM transactions 
WHERE user_id = ? 
ORDER BY created_at DESC;
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
```sql
SELECT 
  COUNT(*) as total_users,
  SUM(pizza_cycles) as total_pizza_gifts,
  SUM(coffee_cycles) as total_coffee_gifts
FROM loyalty;
```

## üöÄ –î–µ–ø–ª–æ–π

### Vercel:
1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel Dashboard
2. –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ `vercel --prod`
3. –ë–î –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä:
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `npm start`
3. –ë–î —Å–æ–∑–¥–∞—Å—Ç—Å—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø—É—Ç–∏

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –±–æ—Ç–æ–º

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –±–æ—Ç, –¥–æ–±–∞–≤—å—Ç–µ –≤ `server/index.ts`:

```typescript
import bot from './bot';

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch();
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —à—Ç–∞–º–ø–∞ –∞–¥–º–∏–Ω–æ–º:
```typescript
// –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
await addStamp(123456789, 'pizza', adminTgId);
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
const cardData = await getCardByTgId(123456789);
if (cardData) {
  const message = cardMessage(
    cardData.user.first_name,
    cardData.card.pizza_count,
    cardData.card.coffee_count,
    cardData.card.pizza_cycles,
    cardData.card.coffee_cycles
  );
}
```

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–î –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ `server/data/`

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `BOT_TOKEN` –∏ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ –≤ `ADMIN_IDS`

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `npm install`

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –ë–î

---

**–ú–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ**
