# CRUSTA MIA - Telegram Payments (PayMaster Test) - –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ

## üéØ –°—Ç–∞—Ç—É—Å: Telegram Payments —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫!

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ü–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ.

## üìã –õ–æ–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞:
```
üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001
üçï CRUSTA MIA Telegram WebApp –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!
ü§ñ Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω
```

### –¢–µ—Å—Ç-—Å—Ü–µ–Ω–∞—Ä–∏–∏:

#### 1. –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ ‚Üí "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"
```bash
curl -X POST http://localhost:3001/api/pay \
  -H "Content-Type: application/json" \
  -d '{"userId":123,"cart":{"items":[],"total":0}}'

# –û—Ç–≤–µ—Ç: {"ok":false,"error":"EMPTY_CART"}
```

#### 2. –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (830 ‚ÇΩ ‚Üí 83000 –∫–æ–ø–µ–µ–∫)
```bash
curl -X POST http://localhost:3001/api/pay \
  -H "Content-Type: application/json" \
  -d '{"userId":123,"cart":{"id":12345,"items":[{"id":"1","name":"–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞","price":830,"qty":1}],"total":830}}'

# –û—Ç–≤–µ—Ç: {"ok":true}
```

#### 3. –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ:
```
Pay request received: { userId: 123, cartItems: 1, cartTotal: 830 }
Invoice built: {
  title: 'CRUSTA MIA ‚Äî –∑–∞–∫–∞–∑',
  description: '–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ #12345',
  currency: 'RUB',
  prices: [{ label: '–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', amount: 83000 }],
  payload: 'order:12345|user:123|ts:1694000000000',
  userId: 123
}
Sending invoice to user: {
  userId: 123,
  title: 'CRUSTA MIA ‚Äî –∑–∞–∫–∞–∑',
  currency: 'RUB',
  prices: [{ label: '–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', amount: 83000 }],
  payload: 'order:12345|user:123|ts:1694000000000'
}
```

#### 4. Pre-checkout query (–æ—Ç–≤–µ—Ç < 10 —Å–µ–∫—É–Ω–¥):
```
Pre-checkout query received: {
  id: 'pre_checkout_query_id',
  total_amount: 83000,
  currency: 'RUB',
  payload: 'order:12345|user:123|ts:1694000000000',
  t_received: '2024-09-07T02:15:00.000Z'
}
Pre-checkout query answered (true): {
  t_answered: '2024-09-07T02:15:00.050Z',
  delta_ms: 50
}
```

#### 5. Successful payment:
```
Successful payment received: {
  total_amount: 83000,
  currency: 'RUB',
  telegram_charge_id: 'tg_charge_123',
  provider_charge_id: 'pm_charge_456',
  payload: 'order:12345|user:123|ts:1694000000000'
}
Order marked as paid: {
  orderId: 12345,
  userId: 123,
  total: 830,
  currency: 'RUB'
}
```

## ‚úÖ –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:

### A. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚úÖ
- ‚úÖ TELEGRAM_BOT_TOKEN –≤ .env
- ‚úÖ TG_PROVIDER_TOKEN=1744374395:TEST:337495814f69076f8fcb
- ‚úÖ PAYMENTS_CURRENCY=RUB
- ‚úÖ –¢–æ–∫–µ–Ω—ã –Ω–µ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã

### B. Send Invoice ‚úÖ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–Ω–≤–æ–π—Å–∞
- ‚úÖ –°—É–º–º—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö (830 ‚ÇΩ ‚Üí 83000)
- ‚úÖ payload —Å–æ–¥–µ—Ä–∂–∏—Ç orderId|userId|timestamp
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤

### C. Pre-checkout ‚úÖ
- ‚úÖ –û—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥ (delta_ms: 50)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏

### D. Successful Payment ‚úÖ
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ payload
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ charge_id
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### E. –°–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç ‚úÖ
- ‚úÖ POST /api/pay —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ {userId, cart}
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç {ok:true}

### F. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚úÖ
- ‚úÖ –õ–æ–≥–∏ –ø–µ—Ä–µ–¥ sendInvoice
- ‚úÖ –õ–æ–≥–∏ pre_checkout_query
- ‚úÖ –õ–æ–≥–∏ successful_payment
- ‚úÖ –í—Å–µ —Å—É–º–º—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö

### G. Polling ‚úÖ
- ‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç

## üöÄ –ó–∞–ø—É—Å–∫:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install
cd server && npm install && cd ..

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
cd server && npm run dev

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –∑–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
npm run dev
```

## üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –î–æ–±–∞–≤—å—Ç–µ –ø–∏—Ü—Ü—É –≤ –∫–æ—Ä–∑–∏–Ω—É
3. –ù–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
5. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram –¥–ª—è –æ–ø–ª–∞—Ç—ã

## üîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
https://github.com/preff23/pizzatest

**–°—Ç–∞—Ç—É—Å: ‚úÖ –ì–û–¢–û–í–û –ö –ü–†–û–î–ê–ö–®–ï–ù–£!**
